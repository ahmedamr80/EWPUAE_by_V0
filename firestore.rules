rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      // strict check: must be signed in AND have 'admin' role in their user doc
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // --- USERS ---
    match /users/{userId} {
      allow read: if isSignedIn();
      // Allow users to create their own doc, OR admins to create any doc (Shadow Accounts)
      allow create: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      // Allow users to update their own doc, OR admins to update any doc
      allow update: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      // Allow users to delete their own account, OR admins to delete any account
      allow delete: if isSignedIn() && (request.auth.uid == userId || isAdmin());
    }
    
    // --- CLUBS ---
    match /clubs/{clubId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // --- EVENTS ---
    match /events/{eventId} {
      // 1. Get (Single Document): Strict check - Public OR Admin
      allow get: if resource.data.isPublic == true || isAdmin();
      
      // 2. List (Query): Relaxed check to prevent "Snapshot Listener" error.
      // We rely on the client-side query to filter private events for non-admins.
      allow list: if true; 
      
      allow write: if isAdmin();
    }
    
    // --- REGISTRATIONS ---
    match /registrations/{registrationId} {
      allow read: if isSignedIn() && 
                   (resource.data.playerId == request.auth.uid || 
                    resource.data.player2Id == request.auth.uid || 
                    isAdmin());
      
      // Allow users to create their own registration
      allow create: if isSignedIn() && request.resource.data.playerId == request.auth.uid || isAdmin();
      
      allow update, delete: if isSignedIn() && 
                             (resource.data.playerId == request.auth.uid || 
                              resource.data.player2Id == request.auth.uid || 
                              isAdmin());
    }
    
    // --- TEAMS ---
    match /teams/{teamId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && 
                     (request.resource.data.player1Id == request.auth.uid || 
                      request.resource.data.player2Id == request.auth.uid);
                      
      allow update, delete: if isSignedIn() && 
                             (resource.data.player1Id == request.auth.uid || 
                              resource.data.player2Id == request.auth.uid || 
                              isAdmin());
    }
    
    // --- NOTIFICATIONS ---
    match /notifications/{notificationId} {
      allow read, update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() || isAdmin();
    }
    
    // --- PARTNER REQUESTS ---
    match /partnerRequests/{requestId} {
      allow read: if isSignedIn() && (
        resource.data.requesterId == request.auth.uid || 
        resource.data.targetPlayerId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isSignedIn() && request.resource.data.requesterId == request.auth.uid || isAdmin();
      allow update: if isSignedIn() && request.auth.uid == resource.data.targetPlayerId || isAdmin(); // Target accepts/denies
      allow delete: if isSignedIn() && request.auth.uid == resource.data.requesterId || isAdmin(); // Requester cancels
    }
  }
}